name: CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

jobs:
  js-build:
    name: JS Build & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: js/package-lock.json

      - name: Install JS dependencies
        working-directory: js
        run: npm ci

      - name: Lint JS
        working-directory: js
        # PLACEHOLDER: replace with real lint command (e.g., npm run lint)
        run: echo "PLACEHOLDER - add ESLint/Prettier step here"

      - name: Build JS bundle
        working-directory: js
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: js-dist
          path: public/js/
          if-no-files-found: warn

  php-lint:
    name: PHP Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          tools: composer

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: PHP syntax check
        run: find . -name "*.php" -not -path "*/vendor/*" | xargs php -l

  app-check-code:
    name: Nextcloud app:check-code (placeholder)
    runs-on: ubuntu-latest
    needs: [js-build, php-lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: app:check-code (placeholder)
        # PHP files audited in change nextcloud-app-scaffold-polish (2024):
        #   lib/AppInfo/Application.php       — OCP only, strict_types, void returns ✓
        #   lib/Controller/GameController.php — OCP only, strict_types, typed return ✓
        #   lib/Listener/ContentSecurityPolicyListener.php — OCP only, strict_types, IEventListener ✓
        #
        # PENDING: wire up a real Nextcloud instance in CI to run this check automatically.
        # Future implementation: spin up Nextcloud via Docker Compose, then run:
        #   docker exec nextcloud php occ app:check-code doomnextcloud
        # Target Nextcloud version for checks: NC 27 (minimum supported).
        # See: https://docs.nextcloud.com/server/latest/admin_manual/apps_management.html
        run: |
          echo "PLACEHOLDER: occ app:check-code requires Nextcloud docker environment."
          echo "PHP files manually audited and check-code-ready (see step comment)."
          echo "To test locally: php occ app:check-code doomnextcloud"
