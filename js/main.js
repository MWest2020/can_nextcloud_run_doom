(function(){"use strict";var w,m;const a=((w=window._oc_appswebroots)==null?void 0:w.doomnextcloud)||typeof OC<"u"&&((m=OC.appswebroots)==null?void 0:m.doomnextcloud)||"/custom_apps/doomnextcloud",u=`${a}/public/wasm`,E="2",l=`${u}/doom.js?v=${E}`,_=`${a}/public/assets/freedoom/freedoom1.wad`,f="/freedoom1.wad";function K(e){let n=!1;const c=()=>{var s,o;if(!n){n=!0;try{const t=(o=(s=window.Module)==null?void 0:s.SDL)==null?void 0:o.audioContext;t&&t.state==="suspended"&&t.resume().catch(()=>{})}catch(t){console.warn("[DoomNextcloud] Audio unlock failed (non-fatal):",t)}}};e.addEventListener("click",c,{once:!1}),e.addEventListener("keydown",c,{once:!1})}async function A(){const e=await fetch(_);if(!e.ok)throw new Error(`Failed to load the game. Check that Freedoom assets are installed correctly. (HTTP ${e.status} for ${_})`);const n=await e.arrayBuffer();return new Uint8Array(n)}function x(){return new Promise((e,n)=>{const c=document.createElement("script");c.src=l,c.onload=e,c.onerror=()=>n(new Error(`Failed to load WASM glue script: ${l}`)),document.head.appendChild(c)})}async function Y(e,n){const c=await A();await new Promise((s,o)=>{window.Module={canvas:e,noInitialRun:!0,locateFile:t=>`${u}/${t}?v=${E}`,preRun:[function(){window.Module.FS.createDataFile("/",f.slice(1),c,!0,!0,!0)}],onRuntimeInitialized(){try{n&&(n.hidden=!0),K(e),window.Module.callMain(["-iwad",f,"-nomusic"]),e.focus(),s()}catch(t){o(t)}},print:t=>console.log("[doom]",t),printErr:t=>console.warn("[doom]",t),setStatus:t=>{t&&console.debug("[doom status]",t)}},x().catch(o)})}const R={ArrowUp:173,ArrowDown:175,ArrowLeft:172,ArrowRight:174,Escape:27,Enter:13,Backspace:127,Control:157,Alt:184,Shift:182," ":32,F1:187,F2:188,F3:189,F4:190,F5:191,F6:192,F7:193,F8:194,F9:195,F10:196,F11:215,F12:216,w:119,W:119,a:97,A:97,s:115,S:115,d:100,D:100,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,0:48},F=new Set(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," ","Enter","Escape","Control","Alt","Shift","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"]),i=e=>{if(!e)return!1;const n=e.tagName;return n==="INPUT"||n==="TEXTAREA"||n==="SELECT"||e.isContentEditable};function p(e,n){e.tabIndex<0&&(e.tabIndex=0);const c=(o,t)=>{const r=R[t];if(r===void 0)return;const d=n();d!=null&&d._DG_KeyEvent&&d._DG_KeyEvent(o?1:0,r)};window.addEventListener("keydown",o=>{const t=document.activeElement;console.debug("[DoomNextcloud] keydown",o.key,"active:",t==null?void 0:t.tagName,t==null?void 0:t.id,"textInput:",i(t)),!i(t)&&(F.has(o.key)&&o.preventDefault(),c(!0,o.key))},{capture:!0}),window.addEventListener("keyup",o=>{i(document.activeElement)||(F.has(o.key)&&o.preventDefault(),c(!1,o.key))},{capture:!0}),e.addEventListener("click",()=>e.focus()),e.addEventListener("mousemove",o=>{const t=n();if(!(t!=null&&t._DG_MouseMoveEvent))return;const r=o.movementX??0,d=o.movementY??0;(r!==0||d!==0)&&t._DG_MouseMoveEvent(r,d)});const s=o=>{const t=n();if(!(t!=null&&t._DG_MouseButtonEvent))return;let r=0;o.buttons&1&&(r|=1),o.buttons&2&&(r|=2),o.buttons&4&&(r|=4),t._DG_MouseButtonEvent(r)};e.addEventListener("mousedown",s),e.addEventListener("mouseup",s)}document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("doomnextcloud-canvas"),n=document.getElementById("doomnextcloud-loading"),c=document.getElementById("doomnextcloud-error");if(!e){console.error("[DoomNextcloud] Canvas element not found in DOM.");return}try{p(e,()=>window.Module),await Y(e,n)}catch(s){console.error("[DoomNextcloud] Failed to initialize runtime:",s),n&&(n.hidden=!0),c&&(c.hidden=!1)}})})();
