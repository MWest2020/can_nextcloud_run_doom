(function(){"use strict";var F,f;const i=((F=window._oc_appswebroots)==null?void 0:F.doomnextcloud)||typeof OC<"u"&&((f=OC.appswebroots)==null?void 0:f.doomnextcloud)||"/custom_apps/doomnextcloud",a=`${i}/public/wasm`,u=`${a}/doom.js`,E=`${i}/public/assets/freedoom/freedoom1.wad`,l="/freedoom1.wad";function K(o){let n=!1;const c=()=>{var r,e;if(!n){n=!0;try{const t=(e=(r=window.Module)==null?void 0:r.SDL)==null?void 0:e.audioContext;t&&t.state==="suspended"&&t.resume().catch(()=>{})}catch(t){console.warn("[DoomNextcloud] Audio unlock failed (non-fatal):",t)}}};o.addEventListener("click",c,{once:!1}),o.addEventListener("keydown",c,{once:!1})}async function w(){const o=await fetch(E);if(!o.ok)throw new Error(`Failed to load the game. Check that Freedoom assets are installed correctly. (HTTP ${o.status} for ${E})`);const n=await o.arrayBuffer();return new Uint8Array(n)}function A(){return new Promise((o,n)=>{const c=document.createElement("script");c.src=u,c.onload=o,c.onerror=()=>n(new Error(`Failed to load WASM glue script: ${u}`)),document.head.appendChild(c)})}async function Y(o,n){const c=await w();await new Promise((r,e)=>{window.Module={canvas:o,noInitialRun:!0,locateFile:t=>`${a}/${t}`,preRun:[function(){window.Module.FS.createDataFile("/",l.slice(1),c,!0,!0,!0)}],onRuntimeInitialized(){try{n&&(n.hidden=!0),K(o),window.Module.callMain(["-iwad",l,"-nomusic"]),o.focus(),r()}catch(t){e(t)}},print:t=>console.log("[doom]",t),printErr:t=>console.warn("[doom]",t),setStatus:t=>{t&&console.debug("[doom status]",t)}},A().catch(e)})}const x={ArrowUp:173,ArrowDown:175,ArrowLeft:172,ArrowRight:174,Escape:27,Enter:13,Backspace:127,Control:157,Alt:184,Shift:182," ":32,F1:187,F2:188,F3:189,F4:190,F5:191,F6:192,F7:193,F8:194,F9:195,F10:196,F11:215,F12:216,w:119,W:119,a:97,A:97,s:115,S:115,d:100,D:100,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,0:48},_=new Set(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," ","Enter","Escape","Control","Alt","Shift","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"]);function m(o,n){o.tabIndex<0&&(o.tabIndex=0);const c=(e,t)=>{const s=x[t];if(s===void 0)return;const d=n();d!=null&&d._DG_KeyEvent&&d._DG_KeyEvent(e?1:0,s)};o.addEventListener("keydown",e=>{_.has(e.key)&&e.preventDefault(),c(!0,e.key)}),o.addEventListener("keyup",e=>{_.has(e.key)&&e.preventDefault(),c(!1,e.key)}),o.addEventListener("click",()=>o.focus()),o.addEventListener("mousemove",e=>{const t=n();if(!(t!=null&&t._DG_MouseMoveEvent))return;const s=e.movementX??0,d=e.movementY??0;(s!==0||d!==0)&&t._DG_MouseMoveEvent(s,d)});const r=e=>{const t=n();if(!(t!=null&&t._DG_MouseButtonEvent))return;let s=0;e.buttons&1&&(s|=1),e.buttons&2&&(s|=2),e.buttons&4&&(s|=4),t._DG_MouseButtonEvent(s)};o.addEventListener("mousedown",r),o.addEventListener("mouseup",r)}document.addEventListener("DOMContentLoaded",async()=>{const o=document.getElementById("doomnextcloud-canvas"),n=document.getElementById("doomnextcloud-loading"),c=document.getElementById("doomnextcloud-error");if(!o){console.error("[DoomNextcloud] Canvas element not found in DOM.");return}try{m(o,()=>window.Module),await Y(o,n)}catch(r){console.error("[DoomNextcloud] Failed to initialize runtime:",r),n&&(n.hidden=!0),c&&(c.hidden=!1)}})})();
